<% environments = Hash[{app.environment=> @db_conf}] %>
<% if app[:postgresql] && app.postgresql[:nodes] %>
  <% app.postgresql[:nodes].each do |host| %>
    <% role = app.private_ip==host ? app.postgresql[:replication] : (app.postgresql[:replication]=='master' ? 'slave': 'master') %>
    <% environments["#{app.environment}_#{role}"] = @db_conf %>
    <% environments["#{app.environment}_#{role}"]['host'] = host %>
  <% end %>
<% end %>

<%=YAML.dump(Hash[environments.map {|env, conf| [env, @db_conf.merge(conf).to_hash] }])%>