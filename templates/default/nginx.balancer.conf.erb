## NOTE: THIS FILE IS MANAGED BY CHEF. CHANGES TO THIS FILE WILL BE REMOVED THE NEXT CHEF RUN. IF
#  YOU WISH TO MAKE A MODIFICATION, YOU SHOULD DO SO IN THE CHEF KITCHEN FOR THIS SERVER AND RUN:
#  `amoeba node push --node <%= node[:name] %>`

# Applications load balancing
upstream <%= app[:name] %>-load_balancer {
  <% app[:nginx][:load_balancer].each do |host| %>
        server <%= host %>;
      <% end %>
}

server {
  server_name <%= app[:url] %>;

<% if node[:application][:ssl][:enabled] %>
  <%= 'listen 80;' unless node[:application][:ssl][:force] %>
  listen 443 ssl;
  ssl_certificate         /etc/nginx/ssl/<%= node[:application][:ssl][:cert_name] %>.crt;
  ssl_certificate_key     /etc/nginx/ssl/<%= node[:application][:ssl][:cert_name] %>.key;
<% else %>
  listen 80;
<% end %>

  location / {
    proxy_pass http://<%= app[:name] %>-load_balancer;

    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
  }
}